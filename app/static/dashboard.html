<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>AlgoEdge ‚Ä¢ Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@500;600;700&display=swap"
    rel="stylesheet">
  <style>
    :root {
      /* DARK THEME VARIABLES */
      --bg: #030712;
      --cyan: #22d3ee;
      --cyan-dim: rgba(34, 211, 238, 0.1);
      --glass: rgba(17, 24, 39, 0.7);
      --glass-border: rgba(255, 255, 255, 0.08);
      --text-main: #f3f4f6;
      --text-muted: #94a3b8;
    }

    body {
      background-color: var(--bg);
      color: var(--text-main);
      font-family: 'Inter', system-ui, sans-serif;
      /* Premium Deep Mesh Gradient Animated */
      background-image:
        radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.15) 0px, transparent 50%),
        radial-gradient(at 100% 0%, rgba(124, 58, 237, 0.15) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(236, 72, 153, 0.1) 0px, transparent 50%),
        radial-gradient(at 0% 100%, rgba(16, 185, 129, 0.1) 0px, transparent 50%);
      background-size: 150% 150%;
      background-attachment: fixed;
      animation: aurora 20s ease infinite alternate;
      overflow-x: hidden;
    }

    /* Headings */
    h1,
    h2,
    h3 {
      font-family: 'Outfit', sans-serif;
      letter-spacing: -0.02em;
    }

    /* Glass Effect */
    .glass {
      background: var(--glass);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--glass-border);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 99px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Animations */
    @keyframes fade-in {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse-glow {

      0%,
      100% {
        box-shadow: 0 0 15px var(--cyan-dim);
      }

      50% {
        box-shadow: 0 0 25px rgba(34, 211, 238, 0.3);
      }
    }

    /* Background Animation */
    @keyframes aurora {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    /* Stars */
    .star {
      position: absolute;
      background: white;
      border-radius: 50%;
      opacity: 0;
      animation: twinkle var(--duration) ease-in-out infinite;
      animation-delay: var(--delay);
    }

    @keyframes twinkle {
      0% {
        opacity: 0;
        transform: scale(0.5);
      }

      50% {
        opacity: var(--opacity);
        transform: scale(1.2);
      }

      100% {
        opacity: 0;
        transform: scale(0.5);
      }
    }

    .animate-enter {
      animation: fade-in 0.4s ease-out forwards;
    }

    .delay-100 {
      animation-delay: 0.1s;
    }

    .delay-200 {
      animation-delay: 0.2s;
    }

    /* Components */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.35rem 0.85rem;
      border-radius: 99px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      transition: all 0.2s;
    }

    .badge:hover {
      background: rgba(255, 255, 255, 0.07);
      border-color: rgba(255, 255, 255, 0.15);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.6rem 1.25rem;
      border-radius: 0.75rem;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .btn:active {
      transform: scale(0.97);
    }

    .btn-primary {
      background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
    }

    .btn-primary:hover {
      box-shadow: 0 6px 20px rgba(6, 182, 212, 0.5);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.03);
      color: #94a3b8;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.08);
      color: white;
      border-color: rgba(255, 255, 255, 0.1);
    }

    .btn-danger {
      background: rgba(239, 68, 68, 0.1);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.2);
      color: white;
      border-color: rgba(239, 68, 68, 0.4);
    }

    /* Tables */
    .table-container {
      border-radius: 1rem;
      overflow: hidden;
      border: 1px solid var(--glass-border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: rgba(0, 0, 0, 0.3);
      color: #94a3b8;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      padding: 1rem;
      text-align: left;
    }

    td {
      padding: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
      color: #cbd5e1;
      font-size: 0.9rem;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover td {
      background: rgba(255, 255, 255, 0.02);
    }

    /* Inputs */
    .input-field {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      width: 100%;
      transition: all 0.2s;
    }

    .input-field:focus {
      outline: none;
      border-color: var(--cyan);
      box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.15);
      background: rgba(0, 0, 0, 0.5);
    }

    /* Mono font areas */
    .font-mono {
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
    }
  </style>
</head>

<body class="selection:bg-cyan-500/30 selection:text-cyan-200">

  <!-- Stars Container -->
  <div id="stars" class="fixed inset-0 pointer-events-none z-0"></div>

  <!-- Navbar -->
  <nav class="fixed top-0 w-full z-50 glass border-b border-b-white/5 shadow-2xl">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <!-- Logo -->
        <div class="flex items-center gap-3">
          <div class="relative group">
            <div
              class="absolute -inset-1 bg-gradient-to-r from-cyan-400 to-blue-600 rounded-lg blur opacity-40 group-hover:opacity-75 transition duration-200">
            </div>
            <div
              class="relative bg-gradient-to-br from-cyan-400 to-blue-600 border border-white/10 rounded-lg w-10 h-10 flex items-center justify-center shadow-lg shadow-cyan-500/20">
              <span class="text-white font-bold text-xl font-[Outfit]">A</span>
            </div>
          </div>
          <div class="flex flex-col">
            <span class="text-2xl font-bold text-white tracking-tight leading-none font-[Outfit]">
              AshAlgo
            </span>
            <span class="text-[10px] font-bold text-cyan-400 tracking-[0.2em] leading-none mt-0.5">PRO TERMINAL</span>
          </div>
        </div>

        <!-- Right Side -->
        <div class="flex items-center gap-3">
          <!-- User ID Pill -->
          <div class="hidden md:flex items-center px-3 py-1.5 rounded-full bg-white/5 border border-white/10 gap-2">
            <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
            <span class="text-xs font-bold text-slate-300">User ID : {{ USER_ID }}</span>
          </div>

          <!-- Kite Status -->
          <div id="zbadge"
            class="hidden md:flex items-center px-3 py-1.5 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 gap-2">
            <div class="w-1.5 h-1.5 rounded-full bg-emerald-500"></div>
            <span class="text-[10px] font-bold tracking-wider uppercase">KITE: CONNECTED</span>
          </div>

          <!-- WS Status -->
          <div id="wsbadge"
            class="hidden md:flex items-center px-3 py-1.5 rounded-full bg-white/5 border border-white/10 gap-2">
            <div class="w-1.5 h-1.5 rounded-full bg-slate-500"></div>
            <span class="text-[10px] font-bold text-slate-500 tracking-wider uppercase">WS: CONNECTING</span>
          </div>

          <!-- Kill Switch -->
          <button id="killBtn" onclick="killSwitch()"
            class="hidden sm:flex btn px-4 py-1.5 rounded-lg bg-rose-500/10 text-rose-400 border border-rose-500/20 hover:bg-rose-500/20 transition-all font-bold text-xs uppercase tracking-wider">
            ‚ö†Ô∏è Kill Switch
          </button>

          <!-- Square Off All -->
          <button onclick="exitAllPositions()"
            class="hidden sm:flex btn px-4 py-1.5 rounded-lg bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold text-xs uppercase tracking-wider shadow-lg shadow-purple-500/20 hover:shadow-purple-500/40 border border-white/10 transition-all">
            Square Off All
          </button>

          <!-- Configure Alert -->
          <button onclick="openCfg()"
            class="btn px-4 py-1.5 rounded-lg bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-bold text-xs uppercase tracking-wider shadow-lg shadow-cyan-500/20 hover:shadow-cyan-500/40 border border-white/10 transition-all">
            + Configure Alert
          </button>

          <!-- Settings Icon/Feed -->
          <!-- Settings Icon/Feed -->
          <button onclick="openCred()" title="Broker Credentials"
            class="p-2 rounded-lg bg-white/5 hover:bg-white/10 text-slate-400 hover:text-white transition border border-white/10">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
              </path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content (Stacked) -->
  <main class="max-w-7xl mx-auto px-6 py-28 pb-12 space-y-12">

    <!-- Alerts Section -->
    <section class="animate-enter">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
          <div class="p-2.5 rounded-xl bg-orange-500/10 text-orange-400 border border-orange-500/20">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-white">Live Signals</h2>
            <div class="flex items-center gap-2 mt-1">
              <span id="alertCount"
                class="text-xs font-semibold text-orange-300 bg-orange-500/10 px-2 py-0.5 rounded border border-orange-500/10">0
                Alerts</span>
              <span class="text-xs text-slate-500">Incoming from Chartink</span>
            </div>
          </div>
        </div>
        <div class="flex gap-2">
          <button onclick="loadAlerts()" class="btn btn-secondary text-xs">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
              </path>
            </svg>
            Refresh
          </button>
          <button onclick="clearAllAlerts()"
            class="btn px-3 py-1.5 text-xs bg-rose-500/10 text-rose-400 border border-rose-500/20 hover:bg-rose-500/20 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
              </path>
            </svg>
            Clear All
          </button>
        </div>
      </div>

      <div class="glass table-container">
        <div class="overflow-x-auto">
          <table>
            <thead>
              <tr>
                <th>Alert Name</th>
                <th>Time</th>
                <th>Symbol</th>
                <th class="text-right">LTP</th>
                <th class="text-right">% Change</th>
                <th class="text-center">Status</th>
              </tr>
            </thead>
            <tbody id="alertsBody">
              <tr>
                <td colspan="6" class="text-center py-12 text-slate-500 italic">Waiting for incoming signals...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Positions Section -->
    <section class="animate-enter delay-100">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
          <div
            class="p-2.5 rounded-xl bg-cyan-500/10 text-cyan-400 border border-cyan-500/20 shadow-lg shadow-cyan-500/10">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
              </path>
            </svg>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-white tracking-tight">Active Positions</h2>
            <div class="flex items-center gap-4 mt-2">
              <span id="posCount" class="badge bg-cyan-500/10 text-cyan-300 border-cyan-500/20 px-3 py-1 text-xs">0
                Active</span>
              <div id="totalPnlBadge"
                class="text-xl font-bold font-mono tracking-tight px-4 py-1.5 rounded-lg border border-white/5 bg-slate-800/50 shadow-inner">
                <span class="text-slate-500 text-sm font-sans mr-1">PnL</span>
                <span class="text-slate-300">0.00</span>
              </div>
            </div>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <button onclick="refreshPositions()" class="btn btn-secondary px-3 py-2 text-xs">
            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
              </path>
            </svg>
            Sync
          </button>
        </div>
      </div>
      <div class="glass table-container">
        <div class="overflow-x-auto">
          <table>
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Strategy</th>
                <th class="text-center">Side</th>
                <th class="text-center">Type</th>
                <th class="text-right">Qty</th>
                <th class="text-right">Entry</th>
                <th class="text-right">Target</th>
                <th class="text-right">StopLoss</th>
                <th class="text-right">TSL</th>
                <th class="text-right">LTP</th>
                <th class="text-right">P&L</th>
                <th class="text-center">State</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="posBody">
              <tr>
                <td colspan="13" class="text-center py-12 text-slate-500 italic">No active positions currently.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- ================= MODALS ================= -->

  <!-- Credentials Modal -->
  <div id="credModal" class="fixed inset-0 z-[100] hidden">
    <div class="absolute inset-0 bg-black/90 backdrop-blur-md transition-opacity" onclick="closeCred()"></div>
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-1">
      <!-- Gradient border wrapper -->
      <div
        class="relative rounded-2xl bg-gradient-to-b from-cyan-500/30 to-blue-600/10 p-[1px] shadow-2xl shadow-cyan-900/40 animate-enter">
        <div class="glass rounded-2xl p-8 border-0 bg-[#0B1121]">
          <button onclick="closeCred()"
            class="absolute top-4 right-4 text-slate-500 hover:text-white transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>

          <div class="flex items-center gap-4 mb-8">
            <div class="relative group">
              <div
                class="absolute -inset-1 bg-gradient-to-r from-blue-500 to-cyan-400 rounded-xl blur opacity-40 group-hover:opacity-60 transition duration-200">
              </div>
              <div
                class="relative w-14 h-14 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center text-white shadow-xl shadow-blue-500/30">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z">
                  </path>
                </svg>
              </div>
            </div>
            <div>
              <h3 class="text-2xl font-bold text-white tracking-tight font-[Outfit]">Connect Broker</h3>
              <div class="flex items-center gap-2 text-xs font-semibold text-emerald-400 mt-1">
                <span class="relative flex h-2 w-2">
                  <span
                    class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                </span>
                Encrypted & Secure
              </div>
            </div>
          </div>

          <p class="text-sm text-slate-400 mb-6 leading-relaxed">
            Enter your <strong>Zerodha Kite API</strong> credentials. These are stored locally on your machine for
            trading execution.
          </p>

          <div class="space-y-6">
            <div class="group">
              <label
                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 ml-1 group-focus-within:text-cyan-400 transition-colors">API
                Key</label>
              <div class="relative">
                <input id="api_key" type="password"
                  class="w-full bg-[#151b2d] border border-white/5 text-white text-sm rounded-xl px-4 py-3.5 focus:outline-none focus:border-cyan-500/50 focus:ring-1 focus:ring-cyan-500/50 transition-all placeholder:text-slate-700 shadow-inner"
                  placeholder="Enter API Key ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <button type="button" onclick="toggleVisibility('api_key')"
                  class="absolute inset-y-0 right-0 px-4 flex items-center text-slate-600 hover:text-cyan-400 transition-colors">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z">
                    </path>
                  </svg>
                </button>
              </div>
            </div>

            <div class="group">
              <label
                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 ml-1 group-focus-within:text-cyan-400 transition-colors">API
                Secret</label>
              <div class="relative">
                <input id="api_secret" type="password"
                  class="w-full bg-[#151b2d] border border-white/5 text-white text-sm rounded-xl px-4 py-3.5 focus:outline-none focus:border-cyan-500/50 focus:ring-1 focus:ring-cyan-500/50 transition-all placeholder:text-slate-700 shadow-inner"
                  placeholder="Enter API Secret ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <button type="button" onclick="toggleVisibility('api_secret')"
                  class="absolute inset-y-0 right-0 px-4 flex items-center text-slate-600 hover:text-cyan-400 transition-colors">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
                    </path>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <div class="flex flex-col gap-3 mt-10">
            <button onclick="saveCred()"
              class="w-full py-4 rounded-xl bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-bold shadow-lg shadow-cyan-500/25 hover:shadow-cyan-500/40 hover:-translate-y-0.5 active:translate-y-0 transition-all flex items-center justify-center gap-2 group">
              <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4">
                </path>
              </svg>
              Save Secure Credentials
            </button>
            <button onclick="connectZerodha()"
              class="w-full py-3.5 rounded-xl bg-transparent text-slate-400 font-semibold border border-slate-700/50 hover:border-slate-500 hover:text-white transition-all flex items-center justify-center gap-2 hover:bg-white/5">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1">
                </path>
              </svg>
              Log in to Kite
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Config Modal -->
  <div id="cfgModal" class="fixed inset-0 z-[100] hidden overflow-y-auto">
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeCfg()"></div>
    <div class="relative min-h-screen flex items-center justify-center p-4">
      <div class="glass rounded-2xl p-8 border border-white/10 shadow-2xl w-full max-w-2xl relative animate-enter my-8">
        <button onclick="closeCfg()" class="absolute top-6 right-6 text-slate-400 hover:text-white">‚úï</button>

        <div class="flex items-center justify-between mb-8">
          <div>
            <h3 class="text-xl font-bold text-white">Strategy Configuration</h3>
            <p class="text-sm text-slate-400">Define parameters for your Chartink alerts.</p>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="col-span-2 md:col-span-1">
            <label class="block text-xs font-semibold text-cyan-400 uppercase mb-1.5">Alert Name</label>
            <input id="cfg_alert" class="input-field" placeholder="e.g. BULLISH_BREAKOUT">
            <p class="text-[10px] text-slate-500 mt-1">Must match Chartink alert name exactly</p>
          </div>
          <div>
            <label class="block text-xs font-semibold text-slate-400 uppercase mb-1.5">Status</label>
            <select id="cfg_enabled" class="input-field">
              <option value="true">Active</option>
              <option value="false">Paused</option>
            </select>
          </div>

          <div>
            <label class="block text-xs font-semibold text-slate-400 uppercase mb-1.5">Trade Direction</label>
            <select id="cfg_dir" class="input-field">
              <option value="LONG">LONG (Buy)</option>
              <option value="SHORT">SHORT (Sell)</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-semibold text-slate-400 uppercase mb-1.5">Product Type</label>
            <select id="cfg_prod" class="input-field">
              <option value="MIS">MIS (Intraday)</option>
              <option value="CNC">CNC (Delivery)</option>
            </select>
          </div>

          <div class="col-span-2 grid grid-cols-3 gap-6">
            <div>
              <label class="block text-xs font-semibold text-slate-400 uppercase mb-1.5">Sizing Mode</label>
              <select id="cfg_qtymode" class="input-field">
                <option value="CAPITAL">Capital Based</option>
                <option value="QTY">Fixed Quantity</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-400 uppercase mb-1.5">Capital (‚Çπ)</label>
              <input id="cfg_cap" type="number" class="input-field" placeholder="e.g. 20000">
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-400 uppercase mb-1.5">Fixed Qty</label>
              <input id="cfg_qty" type="number" class="input-field" placeholder="e.g. 1">
            </div>
          </div>

          <!-- Risk Management -->
          <div class="col-span-2 border-t border-white/5 pt-4 mt-2">
            <h4 class="text-sm font-bold text-white mb-4">Risk Management (MIS Only)</h4>
            <div class="grid grid-cols-3 gap-4">
              <div>
                <label class="block text-xs font-semibold text-emerald-400 uppercase mb-1.5">Target %</label>
                <input id="cfg_tgt" type="number" step="0.1" class="input-field">
              </div>
              <div>
                <label class="block text-xs font-semibold text-rose-400 uppercase mb-1.5">Stop Loss %</label>
                <input id="cfg_sl" type="number" step="0.1" class="input-field">
              </div>
              <div>
                <label class="block text-xs font-semibold text-blue-400 uppercase mb-1.5">Trailing SL %</label>
                <input id="cfg_tsl" type="number" step="0.1" class="input-field">
              </div>
            </div>
          </div>

          <!-- Entry Time Window -->
          <div class="col-span-2 border-t border-white/5 pt-4 mt-2">
            <h4 class="text-sm font-bold text-white mb-4">Entry Time Window</h4>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-semibold text-cyan-400 uppercase mb-1.5">Entry Start Time</label>
                <input id="cfg_entry_start" type="time" class="input-field" value="09:15">
                <p class="text-[10px] text-slate-500 mt-1">Alerts before this time will be rejected</p>
              </div>
              <div>
                <label class="block text-xs font-semibold text-orange-400 uppercase mb-1.5">Entry End Time</label>
                <input id="cfg_entry_end" type="time" class="input-field" value="15:15">
                <p class="text-[10px] text-slate-500 mt-1">Alerts after this time will be rejected</p>
              </div>
            </div>
          </div>

          <div class="col-span-2 border-t border-white/5 pt-4">
            <div class="flex items-center gap-6">
              <div class="flex-1">
                <label class="block text-xs font-semibold text-slate-400 uppercase mb-1.5">Max Trades / Day</label>
                <input id="cfg_limit" type="number" class="input-field">
              </div>
              <div class="flex-[1.5] grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs font-semibold text-slate-400 uppercase mb-1.5">Sector Filter</label>
                  <select id="cfg_sector_on" class="input-field w-full">
                    <option value="false">OFF</option>
                    <option value="true">ON</option>
                  </select>
                </div>
                <div>
                  <label class="block text-xs font-semibold text-slate-400 uppercase mb-1.5">Top N Sectors</label>
                  <input id="cfg_topn" type="number" class="input-field" placeholder="e.g. 2">
                </div>
              </div>
            </div>
            <!-- Dynamic Top Sectors Display -->
            <div id="topSecContainer" class="col-span-2 mt-2 hidden">
              <label class="block text-xs font-semibold text-emerald-400 uppercase mb-1.5">Current Top Sectors</label>
              <div id="topSecList" class="flex flex-wrap gap-2 text-xs">
                <!-- Injected by JS -->
              </div>
            </div>
          </div>
        </div>

        <div class="flex gap-3 mt-8 pt-6 border-t border-white/10">
          <button onclick="saveCfg()" class="btn btn-primary flex-1">Save Configuration</button>
          <button onclick="loadCfgList()" class="btn btn-secondary">Reload</button>
        </div>

        <div class="mt-8">
          <h4 class="text-xs font-bold text-slate-500 uppercase mb-3">Saved Strategies</h4>
          <div id="cfgList" class="space-y-2 max-h-40 overflow-y-auto pr-2">
            <!-- Items injected by JS -->
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="fixed inset-0 z-[150] hidden">
    <div class="absolute inset-0 bg-black/90 backdrop-blur-md transition-opacity"></div>
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-sm p-4">
      <div class="relative bg-slate-900 border border-white/10 rounded-2xl p-6 shadow-2xl animate-enter">
        <h3 class="text-lg font-bold text-white mb-2 font-[Outfit]">Confirm Action</h3>
        <p id="confirmMsg" class="text-slate-400 text-sm mb-6 leading-relaxed">Are you sure?</p>
        <div class="flex gap-3 justify-end">
          <button id="btnCancel" class="btn btn-secondary text-xs px-4">Cancel</button>
          <button id="btnConfirm"
            class="btn btn-primary bg-gradient-to-r from-amber-500 to-orange-600 border-amber-500/20 text-xs px-4 shadow-amber-900/20">Yes,
            Proceed</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container"
    class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[200] flex flex-col items-center gap-2 pointer-events-none"></div>

  <script>
    const USER_ID = "{{USER_ID}}";

    /* ================= UI HELPERS ================= */
    function toast(msg, type = 'success') {
      const container = document.getElementById('toast-container');
      const el = document.createElement('div');

      const colors = type === 'error'
        ? 'bg-rose-500/10 border-rose-500/20 text-rose-200'
        : 'bg-emerald-500/10 border-emerald-500/20 text-emerald-200';

      const icon = type === 'error' ? '‚ö†Ô∏è' : '‚úÖ';

      el.className = `glass px-4 py-3 rounded-xl border flex items-center gap-3 shadow-xl backdrop-blur-xl animate-enter ${colors}`;
      el.innerHTML = `<span class="text-lg">${icon}</span><span class="text-sm font-medium">${msg}</span>`;

      container.appendChild(el);
      setTimeout(() => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(10px)';
        setTimeout(() => el.remove(), 300);
      }, 3000);
    }

    function toggleVisibility(id) {
      const el = document.getElementById(id);
      el.type = el.type === 'password' ? 'text' : 'password';
    }

    /* ================= LOGIC TOASTS & API ================= */
    // ... (Retaining original logic, just mapping to new UI IDs) ...

    function openCred() { document.getElementById("credModal").classList.remove("hidden"); }
    function closeCred() { document.getElementById("credModal").classList.add("hidden"); }

    function openConfirm(msg) {
      return new Promise((resolve) => {
        const el = document.getElementById("confirmModal");
        const msgEl = document.getElementById("confirmMsg");
        const btnYes = document.getElementById("btnConfirm");
        const btnNo = document.getElementById("btnCancel");

        msgEl.textContent = msg;
        el.classList.remove("hidden");

        const cleanup = () => {
          el.classList.add("hidden");
          btnYes.onclick = null;
          btnNo.onclick = null;
        };

        btnYes.onclick = () => { cleanup(); resolve(true); };
        btnNo.onclick = () => { cleanup(); resolve(false); };
      });
    }

    async function fetchTopSectors() {
      try {
        const limit = document.getElementById("cfg_topn").value || 3;
        const r = await fetch(`/api/sectors/top?user_id=${USER_ID}&limit=${limit}`);
        const d = await r.json();

        const cont = document.getElementById("topSecContainer");
        const list = document.getElementById("topSecList");

        if (d.sectors && d.sectors.length > 0) {
          cont.classList.remove("hidden");
          list.innerHTML = d.sectors.map((s, i) => `
                    <div class="px-2 py-1 rounded bg-slate-800 border border-slate-700 flex items-center gap-2">
                        <span class="font-bold text-slate-400">#${i + 1}</span>
                        <span class="font-mono text-cyan-300">${s.name}</span>
                        <span class="${s.pct >= 0 ? 'text-emerald-400' : 'text-rose-400'} font-bold">${s.pct > 0 ? '+' : ''}${s.pct.toFixed(2)}%</span>
                    </div>
                `).join('');
        } else {
          cont.classList.add("hidden");
        }
      } catch (e) { console.error("Failed to fetch top sectors", e); }
    }

    document.getElementById("cfg_topn").addEventListener("change", fetchTopSectors);
    document.getElementById("cfg_topn").addEventListener("keyup", fetchTopSectors);

    function closeCfg() { document.getElementById("cfgModal").classList.add("hidden"); }
    function openCfg() {
      document.getElementById("cfgModal").classList.remove("hidden");
      loadCfgList();
    }

    /* --- API Calls with new Toast --- */
    async function saveCred() {
      const api_key = document.getElementById("api_key").value;
      const api_secret = document.getElementById("api_secret").value;
      try {
        const r = await fetch("/api/save-credentials", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: USER_ID, api_key, api_secret })
        });
        const d = await r.json();
        if (d.error) throw d.error;
        toast("Credentials saved successfully");
        closeCred();
      } catch (e) {
        toast(e, 'error');
      }
    }

    function connectZerodha() { location.href = `/connect/zerodha?user_id=${USER_ID}`; }

    async function refreshZ() {
      const el = document.getElementById("zbadge");
      try {
        const r = await (await fetch(`/api/zerodha-status?user_id=${USER_ID}`)).json();
        if (r.connected) {
          el.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-emerald-400 shadow-[0_0_8px_rgba(52,211,153,0.6)] inline-block mr-1.5"></span> KITE: CONNECTED`;
          el.className = "px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wider bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 shadow-[0_0_10px_rgba(16,185,129,0.2)] transition-all";
        } else {
          throw new Error('Disconnected');
        }

        // Kill Switch Status
        const kb = document.getElementById("killBtn");
        if (r.kill_switch) {
          kb.innerHTML = "üõë RESUME TRADING";
          kb.className = "hidden sm:flex btn px-4 py-1.5 rounded-lg bg-rose-600 text-white border border-rose-400 shadow-[0_0_15px_rgba(225,29,72,0.5)] animate-pulse font-bold text-xs uppercase tracking-wider";
        } else {
          kb.innerHTML = "‚ö†Ô∏è KILL SWITCH";
          kb.className = "hidden sm:flex btn px-4 py-1.5 rounded-lg bg-rose-500/10 text-rose-400 border border-rose-500/20 hover:bg-rose-500/20 transition-all font-bold text-xs uppercase tracking-wider";
        }

      } catch {
        el.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-rose-500 inline-block mr-1.5 animate-pulse"></span> KITE: DISCONNECTED`;
        el.className = "px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wider bg-rose-500/10 text-rose-400 border border-rose-500/20 shadow-[0_0_10px_rgba(244,63,94,0.2)] transition-all";
      }
    }

    async function killSwitch() {
      const btn = document.getElementById("killBtn");
      const isKill = btn.innerText.includes("RESUME");

      const msg = isKill
        ? "üü¢ RESUME TRADING? This will re-enable order placement."
        : "‚ö†Ô∏è EMERGENCY: STOP TRADING? This will BLOCK all new entries.";

      if (!confirm(msg)) return;

      // Toggle (if isKill is true, we want enabled=false)
      const enabled = !isKill;

      await fetch("/api/kill-switch", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: USER_ID, enabled: enabled })
      });

      toast(enabled ? "KILL SWITCH ACTIVATED" : "TRADING RESUMED", enabled ? 'error' : 'success');
      refreshZ();
    }

    /* --- Auto Square Off --- */
    // Removed autoSqEnabled, renderAutoSqBtn, checkAutoSqOff, toggleAutoSqOff functions as per instruction.

    /* --- Config Logic --- */
    async function loadCfgList() {
      const d = await (await fetch(`/api/alert-config?user_id=${USER_ID}`)).json();
      const list = document.getElementById("cfgList");
      list.innerHTML = "";
      const cfgs = d.configs || {};

      if (Object.keys(cfgs).length === 0) {
        list.innerHTML = `<div class="text-xs text-slate-500 text-center py-4">No saved strategies found.</div>`;
        return;
      }

      Object.keys(cfgs).sort().forEach(k => {
        const c = cfgs[k];
        const div = document.createElement("div");
        div.className = "group relative flex items-center justify-between p-4 rounded-xl bg-gradient-to-br from-slate-900/80 to-slate-800/80 border border-white/5 hover:border-cyan-500/30 hover:shadow-lg hover:shadow-cyan-900/20 transition-all duration-300 cursor-pointer overflow-hidden";

        // Active indicator strip
        const activeStrip = c.enabled ? `<div class="absolute left-0 top-0 bottom-0 w-1 bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]"></div>` : `<div class="absolute left-0 top-0 bottom-0 w-1 bg-slate-700"></div>`;

        div.onclick = () => fillCfg(k);
        div.innerHTML = `
          ${activeStrip}
          <div class="pl-3">
            <div class="flex items-center gap-2">
               <div class="text-sm font-bold text-white group-hover:text-cyan-400 transition-colors">${k}</div>
               ${c.enabled ? '<span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">ACTIVE</span>' : '<span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-slate-700/30 text-slate-500 border border-white/5">PAUSED</span>'}
            </div>
            <div class="text-[10px] text-slate-400 mt-1 font-mono flex flex-wrap gap-x-3 gap-y-1">
              <span><span class="${c.direction === 'LONG' ? 'text-emerald-400' : 'text-rose-400'}">${c.direction}</span> ‚Ä¢ <span class="text-cyan-200">${c.product}</span></span>
              <span>Target: <span class="text-white">${c.target_pct}%</span></span>
              <span>SL: <span class="text-rose-300">${c.stop_loss_pct}%</span></span>
              <span>TSL: <span class="text-blue-300">${c.trailing_sl_pct}%</span></span>
              <span>Limit: <span class="text-yellow-200">${c.trade_limit_per_day}/day</span></span>
              ${c.sector_filter_on ? `<span>Sector: <span class="text-fuchsia-300">Top ${c.top_n_sector}</span></span>` : ''}
            </div>
          </div>
        `;

        // Wrapper for click handling separation
        const wrapper = document.createElement("div");
        wrapper.className = "flex items-center gap-2 w-full";

        // Trash button
        const delBtn = document.createElement("button");
        delBtn.className = "p-1.5 rounded-md hover:bg-rose-500/20 text-slate-500 hover:text-rose-400 transition-colors z-10";
        delBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;
        delBtn.onclick = (e) => {
          e.stopPropagation(); // prevent filling form
          deleteCfg(k);
        };

        div.appendChild(delBtn); // Append delete button

        // Re-structure to have [Info Area (Clickable)] + [Delete Btn]
        // But simply appending to div (relative) works if styled right. 
        // Let's use flex in parent.
        list.appendChild(div);
      });
    }

    async function fillCfg(name) {
      const d = await (await fetch(`/api/alert-config?user_id=${USER_ID}`)).json();
      const c = (d.configs || {})[name];
      if (!c) return;

      // Populate fields
      const sets = {
        "cfg_alert": name, "cfg_enabled": String(!!c.enabled), "cfg_dir": c.direction,
        "cfg_prod": c.product, "cfg_qtymode": c.qty_mode, "cfg_cap": c.capital,
        "cfg_qty": c.qty, "cfg_tgt": c.target_pct, "cfg_sl": c.stop_loss_pct,
        "cfg_tsl": c.trailing_sl_pct, "cfg_limit": c.trade_limit_per_day,
        "cfg_sector_on": String(!!c.sector_filter_on), "cfg_topn": c.top_n_sector,
        "cfg_entry_start": c.entry_start_time || "09:15",
        "cfg_entry_end": c.entry_end_time || "15:15"
      };
      for (let k in sets) {
        const el = document.getElementById(k);
        if (el) el.value = sets[k];
      }
    }

    async function saveCfg() {
      const payload = {
        user_id: USER_ID,
        alert_name: document.getElementById("cfg_alert").value.trim(),
        enabled: document.getElementById("cfg_enabled").value === "true",
        direction: document.getElementById("cfg_dir").value,
        product: document.getElementById("cfg_prod").value,
        qty_mode: document.getElementById("cfg_qtymode").value,
        capital: parseFloat(document.getElementById("cfg_cap").value || 0),
        qty: parseInt(document.getElementById("cfg_qty").value || 1),
        target_pct: parseFloat(document.getElementById("cfg_tgt").value || 0),
        stop_loss_pct: parseFloat(document.getElementById("cfg_sl").value || 0),
        trailing_sl_pct: parseFloat(document.getElementById("cfg_tsl").value || 0),
        trade_limit_per_day: parseInt(document.getElementById("cfg_limit").value || 0),
        sector_filter_on: document.getElementById("cfg_sector_on").value === "true",
        top_n_sector: parseInt(document.getElementById("cfg_topn").value || 0),
        entry_start_time: document.getElementById("cfg_entry_start").value || "09:15",
        entry_end_time: document.getElementById("cfg_entry_end").value || "15:15",
      };

      if (!payload.alert_name) { toast("Alert Name is required", 'error'); return; }

      try {
        const r = await fetch("/api/alert-config", {
          method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
        });
        const d = await r.json();
        if (d.error) throw d.error;
        toast(`Strategy '${payload.alert_name}' Saved`);
        loadCfgList();
        closeCfg(); // Auto close on save
      } catch (e) { toast(e, 'error'); }
    }

    async function deleteCfg(name) {
      if (!confirm(`Are you sure you want to DELETE strategy '${name}'?`)) return;

      try {
        const r = await fetch("/api/alert-config", {
          method: "DELETE", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: USER_ID, alert_name: name })
        });
        const d = await r.json();
        if (!d.deleted) throw "Delete failed";
        toast(`Strategy '${name}' deleted`);
        loadCfgList();

        // Clear inputs if deleting currently viewed
        if (document.getElementById("cfg_alert").value === name) {
          document.getElementById("cfg_alert").value = "";
        }
      } catch (e) {
        toast("Failed to delete strategy", 'error');
      }
    }

    /* --- Rendering Logic --- */
    const ALERTS = [];
    let WS = null;
    let POS_MAP = {}; // Global map: symbol -> position object

    // Helper: sanitize symbol for use as HTML ID
    function safeId(symbol) {
      return (symbol || '').replace(/[^a-zA-Z0-9]/g, '_');
    }

    function renderAlerts() {
      const tbody = document.getElementById('alertsBody');
      if (!tbody) return;

      if (ALERTS.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-12 text-slate-500 italic">Waiting for incoming signals...</td></tr>';
        return;
      }

      tbody.innerHTML = ALERTS.slice(0, 100).map(a => {
        const timeStr = new Date(a.time).toLocaleTimeString('en-IN', { timeZone: 'Asia/Kolkata', hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
        const timeClass = "text-slate-500";
        const symbolClass = "font-bold text-slate-200";

        // Generate rows for each result in the alert
        return (a.result || []).map(r => {
          const pChange = parseFloat(r.pct || 0);
          const pClass = pChange > 0 ? "text-emerald-400" : pChange < 0 ? "text-rose-400" : "text-slate-400";

          // Helper for status class (using dark variants)
          const getStatusClass = (status) => {
            switch (status) {
              case 'ENTERED': return 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20';
              case 'SKIPPED': return 'bg-yellow-500/10 text-yellow-400 border border-yellow-500/20';
              case 'ERROR': return 'bg-rose-500/10 text-rose-400 border border-rose-500/20';
              default: return 'bg-slate-800 text-slate-400 border border-slate-700';
            }
          };

          return `
            <tr class="hover:bg-white/5 transition-colors border-b border-white/5 last:border-0">
                <td class="px-4 py-3 whitespace-nowrap">
                    <span class="px-3 py-1.5 rounded-lg text-sm font-bold text-blue-200 tracking-wide">
                        ${a.alert_name}
                    </span>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-xs ${timeClass} font-mono">${timeStr}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm ${symbolClass}">${r.symbol}</td>
                <td class="px-4 py-3 whitespace-nowrap text-right font-mono text-sm text-slate-300" data-symbol="${r.symbol}" data-field="ltp">
                    ${r.ltp ? r.ltp.toFixed(2) : '--'}
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-right font-mono text-sm font-bold ${pClass}" data-symbol="${r.symbol}" data-field="pct">
                    ${r.pct ? r.pct.toFixed(2) + '%' : '--'}
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-center">
                    <span class="px-2 py-1 rounded-full text-[10px] font-bold ${getStatusClass(r.status)}">
                        ${r.status}
                    </span>
                    ${r.status === 'ENTERED' && r.side
              ? `<div class="text-[9px] font-bold mt-0.5 uppercase ${r.side === 'BUY' ? 'text-emerald-400' : 'text-rose-400'}">${r.side}</div>`
              : (r.reason ? `<div class="text-[9px] text-slate-500 mt-0.5 max-w-[120px] truncate mx-auto" title="${r.reason}">${r.reason}</div>` : '')}
                </td>
            </tr>
            `;
        }).join('');
      }).join('');
    }

    async function loadAlerts() {
      try {
        const d = await (await fetch(`/api/alerts?user_id=${USER_ID}&limit=50`)).json();
        ALERTS.length = 0;
        (d.alerts || []).forEach(a => {
          let t = 0;
          if (a.ts_ms) {
            t = Number(a.ts_ms);
          } else if (a.time) {
            t = Date.parse(a.time);
          }
          if (!t || isNaN(t)) t = Date.now();
          ALERTS.push({
            alert_name: a.alert_name,
            time: t,
            result: a.result || [],
            symbols: a.symbols
          });
        });
        ALERTS.sort((a, b) => b.time - a.time);
        renderAlerts();

        const allSyms = new Set();
        ALERTS.forEach(a => {
          (a.result || []).forEach(r => { if (r.symbol) allSyms.add(r.symbol); });
          if (Array.isArray(a.symbols)) a.symbols.forEach(s => allSyms.add(s));
        });

        if (allSyms.size > 0) {
          const symList = Array.from(allSyms);
          const BATCH_SIZE = 50;
          for (let i = 0; i < symList.length; i += BATCH_SIZE) {
            const batch = symList.slice(i, i + BATCH_SIZE);
            fetch("/api/subscribe-symbols", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ user_id: USER_ID, symbols: batch })
            }).catch(e => console.error("Auto-sub batch failed", e));
          }
        }
      } catch (e) { console.error(e); }
    }

    async function refreshPositions() {
      const d = await (await fetch(`/api/positions?user_id=${USER_ID}`)).json();
      const pos = d.positions || [];
      const activePos = pos.filter(p => p.status === 'OPEN');
      activePos.sort((a, b) => a.symbol.localeCompare(b.symbol));
      POS_MAP = {};
      pos.forEach(p => { POS_MAP[p.symbol] = p; });
      renderPositions(activePos);
      renderAlerts();
    }

    function renderPositions(rows) {
      const tbody = document.getElementById("posBody");
      const countEl = document.getElementById("posCount");
      const pnlEl = document.getElementById("totalPnlBadge");

      let totalPnl = 0.0;
      if (rows) {
        rows.forEach(p => totalPnl += Number(p.pnl || 0));
      }

      if (countEl) countEl.textContent = `${rows ? rows.length : 0} Active`;

      if (pnlEl) {
        const val = totalPnl.toFixed(2);
        const colorClass = totalPnl > 0 ? "text-emerald-400 drop-shadow-[0_0_8px_rgba(52,211,153,0.4)]" : totalPnl < 0 ? "text-rose-400 drop-shadow-[0_0_8px_rgba(251,113,133,0.4)]" : "text-white";
        pnlEl.className = `flex items-center gap-4 px-5 py-2.5 bg-[#0B1221] border border-white/5 rounded-2xl shadow-inner`;
        pnlEl.innerHTML = `<span class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em]">NET PNL</span><span class="text-2xl font-mono font-bold tracking-tighter leading-none ${colorClass}">${val}</span>`;
      }

      if (!rows || rows.length === 0) {
        tbody.innerHTML = `<tr><td colspan="13" class="text-center py-12 text-slate-400 italic">No active positions currently.</td></tr>`;
        return;
      }

      tbody.innerHTML = rows.map(p => {
        const pnlClass = p.pnl > 0 ? 'text-emerald-400' : p.pnl < 0 ? 'text-rose-400' : 'text-slate-400';
        const sideClass = p.side === 'BUY' ? 'text-emerald-400 bg-emerald-500/10 border border-emerald-500/20' : 'text-rose-400 bg-rose-500/10 border border-rose-500/20';

        let tslPrice = 0.0;
        const tslPct = Number(p.tsl_pct || 0);
        if (tslPct > 0) {
          if (p.side === 'BUY' && Number(p.highest || 0) > 0) {
            tslPrice = Number(p.highest) * (1.0 - tslPct / 100.0);
          } else if (p.side === 'SELL' && Number(p.lowest || 0) > 0) {
            tslPrice = Number(p.lowest) * (1.0 + tslPct / 100.0);
          }
        }

        const tslDisplay = tslPrice > 0 ? tslPrice.toFixed(2) : '-';

        return `
          <tr class="group text-sm hover:bg-white/5 border-b border-white/5">
            <td class="font-mono px-3 py-3">
              <div class="flex items-center">
                ${p.sector ? `<span class="px-2 py-0.5 mr-2 text-[10px] font-bold rounded bg-sky-500/10 text-sky-400 border border-sky-500/20 shadow-sm whitespace-nowrap tracking-wide">${p.sector}</span>` : ''}
                <span class="font-bold text-slate-200 text-sm">${p.symbol}</span>
              </div>
            </td>
            <td class="text-center px-3 py-3"><span class="px-2 py-0.5 rounded text-[10px] font-bold ${sideClass}">${p.side}</span></td>
            <td class="text-right px-3 py-3 font-mono text-blue-300">${tslDisplay}</td>
            <td class="text-right px-3 py-3 font-mono text-cyan-200" id="pltp-${p.symbol}">${Number(p.ltp || 0).toFixed(2)}</td>
            <td class="text-right px-3 py-3 font-mono font-bold ${pnlClass}" id="ppnl-${p.symbol}">${Number(p.pnl || 0).toFixed(2)}</td>
            <td class="text-center text-xs text-slate-400">
              ${p.status}
              ${p.exit_reason ? `<div class="text-[9px] opacity-70">${p.exit_reason}</div>` : ''}
            </td>
            <td class="text-center">
              <button onclick="squareoff('${p.symbol}')" class="px-2 py-1 text-[10px] font-bold uppercase tracking-wide rounded bg-rose-500/10 text-rose-400 border border-rose-500/20 hover:bg-rose-500/20 hover:text-rose-200 transition-colors">
                Square Off
              </button>
            </td>
          </tr >
        `;
      }).join('');
    }

    async function squareoff(sym) {
      try {
        const r = await fetch("/api/position/squareoff", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: USER_ID, symbol: sym })
        });
        const d = await r.json();
        if (d.error) throw d.error;
        toast(`Exit order sent for ${sym}`);
        setTimeout(refreshPositions, 500);
      } catch (e) { toast(e, 'error'); }
    }

    async function exitAllPositions() {
      if (!await openConfirm("‚ö†Ô∏è ARE YOU SURE? This will close ALL open positions immediately.")) return;
      try {
        const r = await fetch("/api/position/exit-all", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: USER_ID })
        });
        const d = await r.json();
        toast(`Triggered exit for ${d.count} positions`);
        // Auto refresh happens via WS, but manual sync is good backup
      } catch (e) { toast("Failed to exit all", 'error'); }
    }

    async function clearAllAlerts() {
      if (!await openConfirm("‚ö†Ô∏è Delete ALL alert history? This cannot be undone.")) return;
      try {
        const r = await fetch(`/api/alerts?user_id=${USER_ID}`, {
          method: "DELETE"
        });
        const d = await r.json();
        if (d.error) throw d.error;
        toast("All alerts cleared successfully");
        loadAlerts(); // Refresh to show empty table
      } catch (e) { toast(e, 'error'); }
    }

    /* --- WebSocket --- */
    /* --- WebSocket --- */
    function startWS() {
      const el = document.getElementById("wsbadge");
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      WS = new WebSocket(`${proto}://${location.host}/ws/feed?user_id=${USER_ID}`);

      WS.onopen = () => {
        el.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-blue-400 shadow-[0_0_8px_rgba(96,165,250,0.6)] inline-block mr-1.5"></span> WS: LIVE`;
        el.className = "px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wider bg-blue-500/10 text-blue-400 border border-blue-500/20 shadow-[0_0_10px_rgba(59,130,246,0.3)] transition-all";
      };

      WS.onclose = () => {
        el.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-rose-500 inline-block mr-1.5 animate-pulse"></span> FEED: DISCONNECTED`;
        el.className = "px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wider bg-rose-500/10 text-rose-400 border border-rose-500/20 shadow-[0_0_10px_rgba(244,63,94,0.2)] transition-all";
        setTimeout(startWS, 2000);
      };

      WS.onmessage = (ev) => {
        try {
          const d = JSON.parse(ev.data);
          // console.log("Incoming WS:", d); // Keep for debug if needed

          if (d.type === 'tick') {
            const s = d.symbol;
            const sid = safeId(s); // Use safe ID for alerts
            const ltp = Number(d.ltp || 0).toFixed(2);
            const close = Number(d.close || 0);
            const pctChange = close > 0 ? ((d.ltp - close) / close * 100).toFixed(2) : '0.00';
            const pctStr = pctChange + '%';

            // Update Alert Table - LTP & % Change using data attributes (Robust)
            document.querySelectorAll(`[data-symbol="${s}"][data-field="ltp"]`).forEach(el => {
              el.innerText = ltp;
              const ltpColor = d.ltp > close ? 'text-emerald-400' : d.ltp < close ? 'text-rose-400' : 'text-slate-300';
              // Preserve base classes + update color
              el.className = `text-right font-mono ${ltpColor}`;
            });

            document.querySelectorAll(`[data-symbol="${s}"][data-field="pct"]`).forEach(el => {
              el.innerText = pctStr;
              const pctColor = parseFloat(pctChange) > 0 ? 'text-emerald-400' : parseFloat(pctChange) < 0 ? 'text-rose-400' : 'text-slate-400';
              el.className = `text-right font-mono ${pctColor}`;
            });

            // Update TSL in Alert Table dynamically from POS_MAP
            const p = POS_MAP[s]; // Lookup from map by raw symbol
            if (p) {
              let tslPrice = 0.0;
              const tslPct = Number(p.tsl_pct || 0);
              // Update high/low locally for immediate TSL feedback
              if (p.side === 'BUY') {
                p.highest = Math.max(Number(p.highest || 0), Number(d.ltp));
                if (tslPct > 0 && p.highest > 0) tslPrice = p.highest * (1.0 - tslPct / 100.0);
              } else if (p.side === 'SELL') {
                p.lowest = (Number(p.lowest) === 0 ? Number(d.ltp) : Math.min(Number(p.lowest), Number(d.ltp)));
                if (tslPct > 0 && p.lowest > 0) tslPrice = p.lowest * (1.0 + tslPct / 100.0);
              }

              if (tslPrice > 0) {
                const tslVal = tslPrice.toFixed(2);
                document.querySelectorAll(`.atsl-${sid}`).forEach(el => el.innerText = tslVal);
              }
            }

            // Update Position Table
            const pLtp = document.getElementById(`pltp-${s}`);
            if (pLtp) pLtp.innerText = ltp;
          }

          if (d.type === 'alert') {
            // Toast logic removed as per user request (only show in table)
            loadAlerts();
          }

          if (d.type === 'pos' || d.type === 'pos_refresh') {
            if (d.type === 'pos' && d.position) {
              // Update or remove from map based on status
              if (d.position.status === 'OPEN') {
                POS_MAP[d.position.symbol] = d.position;
              } else {
                // Remove closed/error positions from map
                delete POS_MAP[d.position.symbol];
              }

              // Render only OPEN positions
              const activePos = Object.values(POS_MAP).filter(p => p.status === 'OPEN');
              // Sort alphabetically by symbol
              activePos.sort((a, b) => a.symbol.localeCompare(b.symbol));

              renderPositions(activePos);
              renderAlerts();
            } else {
              refreshPositions();
            }
          }

        } catch (e) { }
      };
    }

    // Init
    document.addEventListener("DOMContentLoaded", () => {
      createStars();
      refreshZ();
      // checkAutoSqOff(); // Removed as we switched to manual button
      setInterval(refreshZ, 5000);
      loadAlerts();
      refreshPositions();
      startWS();
    });

    function createStars() {
      const container = document.getElementById("stars");
      if (!container) return;
      const count = 60; // Number of stars
      for (let i = 0; i < count; i++) {
        const star = document.createElement("div");
        star.className = "star";
        const xy = [Math.random() * 100, Math.random() * 100];
        const duration = 2 + Math.random() * 3; // 2-5s
        const delay = Math.random() * 5;
        const size = 1 + Math.random() * 2; // 1-3px
        const opacity = 0.3 + Math.random() * 0.7;

        star.style.left = `${xy[0]}%`;
        star.style.top = `${xy[1]}%`;
        star.style.width = `${size}px`;
        star.style.height = `${size}px`;
        star.style.setProperty("--duration", `${duration}s`);
        star.style.setProperty("--delay", `${delay}s`);
        star.style.setProperty("--opacity", opacity);

        container.appendChild(star);
      }
    }

  </script>
</body>

</html>